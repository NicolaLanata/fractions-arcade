<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Equivalent Fractions</title>
<style>
  :root{
    --bg:#f6f7fb;
    --panel:#ffffff;
    --border:rgba(0,0,0,0.12);
    --text:#111827;
    --muted:rgba(17,24,39,0.65);
    --accent:#2563eb;
    --good:#16a34a;
    --bad:#dc2626;
    --warn:#f59e0b;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }

  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:var(--sans);
    display:flex;
    justify-content:center;
    padding:18px;
  }
  #app{ width:min(920px, 100%); }

  #top{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  #title{
    font-weight:900;
    font-size:20px;
    letter-spacing:0.01em;
  }
  #meta{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }
  .pill{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:999px;
    padding:10px 14px;
    display:flex;
    align-items:center;
    gap:8px;
    box-shadow:0 1px 8px rgba(0,0,0,0.04);
    font-weight:900;
    color:rgba(17,24,39,0.85);
  }
  .pill .lbl{
    font-size:12px;
    font-weight:900;
    color:var(--muted);
    letter-spacing:0.06em;
    text-transform:uppercase;
  }
  #timeOut{
    font-family:var(--mono);
    font-size:16px;
    color:var(--accent);
  }
  #bestOut{
    font-family:var(--mono);
    font-size:13px;
    color:rgba(17,24,39,0.80);
    white-space:nowrap;
  }

  #panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px;
    box-shadow:0 1px 8px rgba(0,0,0,0.04);
  }

  #lights{
    display:flex;
    gap:8px;
    align-items:center;
    margin: 4px 0 10px 0;
  }
  .light{
    width:14px;
    height:14px;
    border-radius:50%;
    background:rgba(0,0,0,0.10);
    border:1px solid rgba(0,0,0,0.12);
  }
  .light.green{ background:rgba(22,163,74,0.85); border-color:rgba(22,163,74,0.35); }
  .light.yellow{ background:rgba(245,158,11,0.85); border-color:rgba(245,158,11,0.35); }
  .light.red{ background:rgba(220,38,38,0.85); border-color:rgba(220,38,38,0.35); }

  #prompt{
    font-weight:900;
    color:rgba(17,24,39,0.80);
    min-height:22px;
    margin: 6px 0 6px 0;
  }

  #eqWrap{
    display:flex;
    justify-content:center;
    margin: 10px 0 8px 0;
  }
  .eq{
    display:flex;
    align-items:center;
    gap:16px;
  }
  .frac{
    display:flex;
    flex-direction:column;
    align-items:center;
    min-width:96px;
  }
  .frac .num, .frac .den{
    font-family:var(--mono);
    font-weight:900;
    font-size:44px;
    line-height:1.0;
    min-height:48px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .frac .bar{
    width:78px;
    height:4px;
    background:rgba(0,0,0,0.35);
    border-radius:3px;
    margin:8px 0;
  }
  .eqSign{
    font-family:var(--mono);
    font-weight:900;
    font-size:38px;
    color:rgba(37,99,235,0.75);
  }

  .ans{
    width:96px;
    font-family:var(--mono);
    font-weight:900;
    font-size:40px;
    text-align:center;
    border:2px solid rgba(37,99,235,0.35);
    border-radius:12px;
    padding:4px 6px;
    outline:none;
    background:#fff;
  }
  .ans:focus{
    border-color: rgba(37,99,235,0.75);
    box-shadow: 0 0 0 4px rgba(37,99,235,0.12);
  }
  .ans.disabled{
    opacity:0.65;
    pointer-events:none;
  }

  /* hide number spinners (even though we use text, keep it safe) */
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
  input[type=number]{ -moz-appearance:textfield; }

  #actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:center;
    margin-top:8px;
  }
  button{
    font-family:var(--sans);
    font-weight:900;
    font-size:14px;
    padding:10px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    background:var(--panel);
    cursor:pointer;
    user-select:none;
  }
  button.primary{
    background:var(--accent);
    color:white;
    border-color:rgba(37,99,235,0.25);
  }
  button.good{
    background:var(--good);
    color:white;
    border-color:rgba(22,163,74,0.25);
  }
  button:disabled{ opacity:0.45; cursor:default; }

  #feedback{
    text-align:center;
    font-weight:900;
    min-height:22px;
    margin-top:10px;
    color:var(--muted);
  }
  #feedback.good{ color:var(--good); }
  #feedback.bad{ color:var(--bad); }
  #feedback.warn{ color:rgba(161,98,7,0.95); }

  /* one box only (hint OR explanation), and it disappears on Next */
  #infoBox{
    margin-top:12px;
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 12px;
    background:rgba(0,0,0,0.02);
    display:none;
  }
  #infoTitle{
    font-size:12px;
    font-weight:900;
    color:var(--muted);
    letter-spacing:0.06em;
    text-transform:uppercase;
    margin-bottom:6px;
  }
  #infoText{
    font-weight:900;
    color:rgba(17,24,39,0.82);
    line-height:1.25;
    margin-bottom:8px;
  }
  svg{
    width:100%;
    height:auto;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.10);
    background:#fff;
  }

  .cutline{ stroke:rgba(0,0,0,0.22); stroke-width:2; stroke-linecap:round; }
  .outline{ stroke:rgba(0,0,0,0.30); stroke-width:3; fill:none; }

  /* Balloons celebration (same idea as sum_mission) */
  .balloon{
    position:absolute;
    bottom:-100px;
    width:40px;
    height:50px;
    border-radius:50%;
    opacity:0.9;
    animation: floatUp 4s ease-in infinite;
    z-index:5;
  }
  @keyframes floatUp{
    0%{ transform: translateY(0) rotate(0deg); opacity:1; }
    100%{ transform: translateY(-120vh) rotate(20deg); opacity:0; }
  }
</style>
</head>
<body>
<script src="assets/js/fractions_games.js"></script>
<script src="assets/js/fractions_app.js"></script>
<div id="app">
  <div id="top">
    <div id="title">Equivalent Fractions</div>
    <div id="meta">
      <div class="pill" title="Best run (correctness first, then time)">
        <div class="lbl">Best</div>
        <div id="bestOut">—</div>
      </div>
      <div class="pill" title="Time (tie-break only)">
        <div class="lbl">Time</div>
        <div id="timeOut">0:00.0</div>
      </div>
    </div>
  </div>

  <div id="panel">
    <div id="lights"></div>
    <div id="prompt"></div>

    <div id="eqWrap">
      <div class="eq" aria-label="equation">
        <div class="frac" aria-label="left fraction">
          <div class="num" id="lNum">—</div>
          <div class="bar"></div>
          <div class="den" id="lDen">—</div>
        </div>

        <div class="eqSign">=</div>

        <div class="frac" aria-label="right fraction">
          <div class="num">
            <span id="rNumText"></span>
            <input id="rNumIn" class="ans" type="text" inputmode="numeric" pattern="[0-9]*" style="display:none;">
          </div>
          <div class="bar"></div>
          <div class="den">
            <span id="rDenText"></span>
            <input id="rDenIn" class="ans" type="text" inputmode="numeric" pattern="[0-9]*" style="display:none;">
          </div>
        </div>
      </div>
    </div>

    <div id="actions">
      <button id="checkBtn" class="primary" type="button">Check</button>
      <button id="nextBtn" class="good" type="button" style="display:none;">Next</button>
      <button id="againBtn" type="button" style="display:none;">Play again</button>
    </div>

    <div id="feedback"></div>

    <div id="infoBox">
      <div id="infoTitle">Hint</div>
      <div id="infoText"></div>
      <svg id="infoSvg" viewBox="0 0 520 170" aria-label="visual"></svg>
    </div>
  </div>
</div>

<script>
(() => {
  const Q_COUNT = 5;
  const BASE_DENOMS = [2, 3, 4, 6];
  const K_CHOICES = [2, 3, 4];
  const MAX_DEN = 12;
  const MAX_PIZZAS_VIS = 3;

  // stable key (do not rename)
  const bestKey = "fractions_equivalents_best_v1";

  const lightsRow = document.getElementById('lights');
  const promptEl  = document.getElementById('prompt');

  const lNum = document.getElementById('lNum');
  const lDen = document.getElementById('lDen');

  const rNumText = document.getElementById('rNumText');
  const rDenText = document.getElementById('rDenText');

  const rNumIn = document.getElementById('rNumIn');
  const rDenIn = document.getElementById('rDenIn');

  const checkBtn = document.getElementById('checkBtn');
  const nextBtn  = document.getElementById('nextBtn');
  const againBtn = document.getElementById('againBtn');

  const feedbackEl = document.getElementById('feedback');

  const infoBox = document.getElementById('infoBox');
  const infoTitle = document.getElementById('infoTitle');
  const infoText = document.getElementById('infoText');
  const infoSvg = document.getElementById('infoSvg');

  const timeOut = document.getElementById('timeOut');
  const bestOut = document.getElementById('bestOut');

  function gcd(a,b){
    a = Math.abs(a); b = Math.abs(b);
    while (b){ const t = a % b; a = b; b = t; }
    return a || 1;
  }
  function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function fmtTime(ms){
    const s = ms/1000;
    const m = Math.floor(s/60);
    const sec = s - 60*m;
    const secInt = Math.floor(sec);
    const tenth = Math.floor((sec-secInt)*10);
    return `${m}:${String(secInt).padStart(2,'0')}.${tenth}`;
  }

  function setFeedback(text, cls=""){
    feedbackEl.textContent = text;
    feedbackEl.classList.remove('good','bad','warn');
    if (cls) feedbackEl.classList.add(cls);
  }

  function showInfo(title, text, q){
    infoTitle.textContent = title;
    infoText.textContent = text;
    infoBox.style.display = 'block';

    // For "Hint", show ONLY the sentence (no visual)
    if (title === "Hint"){
      infoSvg.style.display = 'none';
      while (infoSvg.firstChild) infoSvg.removeChild(infoSvg.firstChild);
      return;
    }

    infoSvg.style.display = 'block';
    drawInfoVisual(q);
  }

  function hideInfo(){
    infoBox.style.display = 'none';
    while (infoSvg.firstChild) infoSvg.removeChild(infoSvg.firstChild);
  }

  // Celebration (balloons), like sum_mission
  function ensureCelebrationArea(){
    let area = document.getElementById("celebration-area");
    if (area) return area;
    area = document.createElement("div");
    area.id = "celebration-area";
    area.style.position = "fixed";
    area.style.top = "0";
    area.style.left = "0";
    area.style.width = "100%";
    area.style.height = "100%";
    area.style.pointerEvents = "none";
    area.style.zIndex = "1";
    document.body.insertBefore(area, document.body.firstChild);
    return area;
  }

  function triggerCelebration(){
    const area = ensureCelebrationArea();
    const colors = [
      "rgba(231,76,60,0.95)",
      "rgba(52,152,219,0.95)",
      "rgba(46,204,113,0.95)",
      "rgba(241,196,15,0.95)",
      "rgba(155,89,182,0.95)"
    ];
    const count = 15;
    for (let i=0; i<count; i++){
      const b = document.createElement("div");
      b.className = "balloon";
      b.style.left = (Math.random()*90) + "%";
      b.style.background = colors[Math.floor(Math.random()*colors.length)];
      const dur = 3 + Math.random()*2;
      b.style.animationDuration = dur + "s";
      area.appendChild(b);
      window.setTimeout(() => { b.remove(); }, Math.ceil(dur*1000) + 250);
    }
  }

  function makeLight(color){
    const d = document.createElement('div');
    d.className = 'light';
    if (color) d.classList.add(color);
    return d;
  }
  function refreshLights(){
    lightsRow.innerHTML = '';
    for (let i=0; i<Q_COUNT; i++){
      const c = state.lights[i];
      lightsRow.appendChild(makeLight(c === 'blank' ? '' : c));
    }
  }

  function loadBest(){
    try{
      const raw = localStorage.getItem(bestKey);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (!Number.isFinite(obj.greens) || !Number.isFinite(obj.yellows) || !Number.isFinite(obj.timeMs)) return null;
      return obj;
    } catch(_){ return null; }
  }
  function saveBest(rec){
    try{ localStorage.setItem(bestKey, JSON.stringify(rec)); } catch(_){}
  }
  function bestLine(rec){
    if (!rec) return "—";
    const reds = Q_COUNT - rec.greens - rec.yellows;
    return `${rec.greens}G ${rec.yellows}Y ${reds}R • ${fmtTime(rec.timeMs)}`;
  }
  function isBetter(a,b){
    if (!b) return true;
    if (a.greens !== b.greens) return a.greens > b.greens;
    if (a.yellows !== b.yellows) return a.yellows > b.yellows;
    return a.timeMs < b.timeMs;
  }

  function mark(color){
    state.lights[state.qIndex] = color;
    refreshLights();
  }

  // ----------------------------
  // Robust question generation
  // ----------------------------
  function genQuestion(){
    const DIV_PROB = 0.35;

    for (let tries=0; tries<400; tries++){
      const b0 = randChoice(BASE_DENOMS);

      const ks = K_CHOICES.filter(k => (k > 1) && (b0 * k <= MAX_DEN));
      if (ks.length === 0) continue;

      const a0 = 1 + Math.floor(Math.random() * (2*b0));
      if (gcd(a0,b0) !== 1) continue;

      const k = randChoice(ks);
      const op = (Math.random() < DIV_PROB) ? 'div' : 'mul';

      let aL,bL,aR,bR;
      if (op === 'mul'){
        aL = a0;     bL = b0;
        aR = a0*k;   bR = b0*k;
      } else {
        aL = a0*k;   bL = b0*k;
        aR = a0;     bR = b0;
      }

      const missing = (Math.random() < 0.5) ? 'num' : 'den';
      const answer = (missing === 'num') ? aR : bR;

      const all = [aL,bL,aR,bR,k,answer];
      if (!all.every(Number.isFinite)) continue;
      if (!all.every(Number.isInteger)) continue;
      if (aL<=0 || bL<=0 || aR<=0 || bR<=0) continue;

      return {aL,bL,aR,bR,op,k,missing,answer};
    }

    return {aL:3,bL:2,aR:6,bR:4,op:'mul',k:2,missing:'num',answer:6};
  }

  function explainText(q){
    if (q.op === 'mul'){
      if (q.missing === 'num'){
        return `We cut each slice into ${q.k} smaller equal slices. The bottom becomes ${q.k} times bigger, so the top must also be ${q.k} times bigger.`;
      } else {
        return `We made the top ${q.k} times bigger. To keep the same amount, the bottom must also be ${q.k} times bigger.`;
      }
    } else {
      if (q.missing === 'num'){
        return `We group the slices in groups of ${q.k}. The bottom becomes ${q.k} times smaller, so the top must also be ${q.k} times smaller.`;
      } else {
        return `We made the top ${q.k} times smaller. To keep the same amount, the bottom must also be ${q.k} times smaller.`;
      }
    }
  }

  // ----------------------------
  // Equation rendering
  // ----------------------------
  function cleanDigits(el){
    el.value = el.value.replace(/[^\d]/g,'');
  }
  rNumIn.addEventListener('input', () => cleanDigits(rNumIn));
  rDenIn.addEventListener('input', () => cleanDigits(rDenIn));

  function renderEquation(q){
    lNum.textContent = String(q.aL);
    lDen.textContent = String(q.bL);

    rNumIn.value = "";
    rDenIn.value = "";
    rNumIn.classList.remove('disabled');
    rDenIn.classList.remove('disabled');

    rNumText.style.display = 'inline';
    rDenText.style.display = 'inline';
    rNumIn.style.display = 'none';
    rDenIn.style.display = 'none';

    if (q.missing === 'num'){
      rDenText.textContent = String(q.bR);
      rNumText.textContent = "";
      rNumText.style.display = 'none';
      rNumIn.style.display = 'inline-block';
      rNumIn.focus();
    } else {
      rNumText.textContent = String(q.aR);
      rDenText.textContent = "";
      rDenText.style.display = 'none';
      rDenIn.style.display = 'inline-block';
      rDenIn.focus();
    }
  }

  function lockInputs(){
    rNumIn.classList.add('disabled');
    rDenIn.classList.add('disabled');
  }

  function readAnswer(q){
    const raw = (q.missing === 'num') ? rNumIn.value : rDenIn.value;
    if (!raw || raw.trim() === "") return null;
    const v = parseInt(raw,10);
    if (!Number.isFinite(v)) return null;
    return v;
  }

  // ----------------------------
  // Visual (only for explanation)
  // ----------------------------
  function svgEl(tag, attrs={}){
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
    return el;
  }
  function slicePath(cx, cy, r, a0, a1){
    const x0 = cx + r*Math.cos(a0);
    const y0 = cy + r*Math.sin(a0);
    const x1 = cx + r*Math.cos(a1);
    const y1 = cy + r*Math.sin(a1);
    const large = (a1 - a0) > Math.PI ? 1 : 0;
    return `M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} Z`;
  }
  function drawPizza(svg, cx, cy, r, den, filledCount){
    svg.appendChild(svgEl('circle', {
      cx, cy, r,
      fill: 'rgba(0,0,0,0.02)',
      stroke: 'rgba(0,0,0,0.18)',
      'stroke-width': 2
    }));

    if (den <= 1){
      svg.appendChild(svgEl('circle', {
        cx, cy, r: r-1,
        fill: filledCount>=1 ? 'rgba(37,99,235,0.20)' : 'rgba(0,0,0,0.00)',
        stroke: 'none'
      }));
      svg.appendChild(svgEl('circle', { cx, cy, r: r-1, class:'outline' }));
      return;
    }

    const aStart = -Math.PI/2;
    for (let i=0; i<den; i++){
      const a0 = aStart + i*(2*Math.PI/den);
      const a1 = aStart + (i+1)*(2*Math.PI/den);
      const d = slicePath(cx, cy, r-1, a0, a1);
      const isFilled = (i < filledCount);
      svg.appendChild(svgEl('path', { d, fill: isFilled ? 'rgba(37,99,235,0.22)' : 'rgba(0,0,0,0.02)', stroke:'none' }));
    }
    for (let i=0; i<den; i++){
      const a = aStart + i*(2*Math.PI/den);
      const x = cx + (r-2)*Math.cos(a);
      const y = cy + (r-2)*Math.sin(a);
      svg.appendChild(svgEl('line', { x1:cx, y1:cy, x2:x, y2:y, class:'cutline' }));
    }
    svg.appendChild(svgEl('circle', { cx, cy, r: r-1, class:'outline' }));
  }

  function drawFraction(svg, num, den, xCenter){
    const pizzas = Math.max(1, Math.ceil(num/den));
    const count = Math.min(MAX_PIZZAS_VIS, pizzas);

    const r = 26, gap = 12;
    const totalW = count*(2*r) + (count-1)*gap;
    const x0 = xCenter - totalW/2 + r;
    const y = 92;

    for (let p=0; p<count; p++){
      const cx = x0 + p*(2*r + gap);
      const fill = Math.max(0, Math.min(den, num - p*den));
      drawPizza(svg, cx, y, r, den, fill);
    }
  }

  function drawInfoVisual(q){
    while (infoSvg.firstChild) infoSvg.removeChild(infoSvg.firstChild);

    infoSvg.appendChild(svgEl('rect', {
      x: 8, y: 8, width: 504, height: 154,
      rx: 14, ry: 14,
      fill: 'rgba(0,0,0,0.00)',
      stroke: 'rgba(0,0,0,0.10)', 'stroke-width': 2
    }));

    const eq = svgEl('text', {
      x: 260, y: 98, 'text-anchor':'middle',
      'font-family': 'ui-monospace, Menlo, monospace',
      'font-weight': 900, 'font-size': 28,
      fill: 'rgba(37,99,235,0.75)'
    });
    eq.textContent = "=";
    infoSvg.appendChild(eq);

    const lt = svgEl('text', {
      x: 130, y: 32, 'text-anchor':'middle',
      'font-family': 'ui-monospace, Menlo, monospace',
      'font-weight': 900, 'font-size': 14,
      fill: 'rgba(17,24,39,0.70)'
    });
    lt.textContent = `${q.aL}/${q.bL}`;
    infoSvg.appendChild(lt);

    const rt = svgEl('text', {
      x: 390, y: 32, 'text-anchor':'middle',
      'font-family': 'ui-monospace, Menlo, monospace',
      'font-weight': 900, 'font-size': 14,
      fill: 'rgba(17,24,39,0.70)'
    });
    rt.textContent = `${q.aR}/${q.bR}`;
    infoSvg.appendChild(rt);

    drawFraction(infoSvg, q.aL, q.bL, 130);
    drawFraction(infoSvg, q.aR, q.bR, 390);
  }

  // ----------------------------
  // Timer + set logic
  // ----------------------------
  function counts(){
    let g=0,y=0,r=0;
    for (const c of state.lights){
      if (c==='green') g++;
      else if (c==='yellow') y++;
      else if (c==='red') r++;
    }
    return {g,y,r};
  }

  function startTimer(){
    if (state.timerId) return;
    state.t0 = performance.now() - state.elapsedMs;
    state.timerId = setInterval(() => {
      if (!state.running) return;
      state.elapsedMs = performance.now() - state.t0;
      timeOut.textContent = fmtTime(state.elapsedMs);
    }, 50);
  }
  function stopTimer(){
    state.running = false;
    if (state.timerId){
      clearInterval(state.timerId);
      state.timerId = null;
    }
  }

  function startSet(){
    stopTimer();
    state.elapsedMs = 0;
    timeOut.textContent = fmtTime(0);

    state.questions = Array.from({length:Q_COUNT}, () => genQuestion());
    state.qIndex = 0;
    state.attempts = 0;
    state.finished = false;

    state.lights = Array(Q_COUNT).fill('blank');
    refreshLights();

    hideInfo();
    setFeedback("");

    checkBtn.style.display = 'inline-block';
    checkBtn.disabled = false;
    nextBtn.style.display = 'none';
    againBtn.style.display = 'none';

    state.running = true;
    startTimer();

    renderCurrent();
  }

  function renderCurrent(){
    const q = state.questions[state.qIndex];
    state.current = q;
    state.attempts = 0;

    promptEl.textContent = `Question ${state.qIndex+1}/${Q_COUNT}: fill the missing number so the fractions are equal.`;

    hideInfo();
    setFeedback("");

    checkBtn.disabled = false;
    nextBtn.style.display = 'none';

    renderEquation(q);
  }

  function finishSet(){
    state.finished = true;
    state.running = false;

    const {g,y,r} = counts();
    const rec = {greens:g, yellows:y, timeMs: Math.round(state.elapsedMs)};
    const best = loadBest();

    if (isBetter(rec, best)){
      saveBest(rec);
      bestOut.textContent = bestLine(rec);
      setFeedback(`Set complete: ${g} green, ${y} yellow, ${r} red. New best!`, "good");
    } else {
      bestOut.textContent = bestLine(best);
      setFeedback(`Set complete: ${g} green, ${y} yellow, ${r} red.`, "");
    }

    checkBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    againBtn.style.display = 'inline-block';

    stopTimer();
  }

  function nextQ(){
    if (state.qIndex >= Q_COUNT-1){
      finishSet();
      return;
    }
    state.qIndex += 1;
    renderCurrent();
  }

  function onCheck(){
    const q = state.current;
    const val = readAnswer(q);

    if (val === null){
      setFeedback("Type a number first.", "warn");
      return;
    }

    if (val === q.answer){
      if (state.attempts === 0){
        mark('green');
        setFeedback("Correct!", "good");
      } else {
        setFeedback("Correct (second try).", "good");
      }

      triggerCelebration();

      lockInputs();
      checkBtn.disabled = true;

      showInfo("Explanation", explainText(q), q);

      nextBtn.style.display = 'inline-block';
      nextBtn.textContent = (state.qIndex === Q_COUNT-1) ? "Finish" : "Next";
      return;
    }

    state.attempts += 1;

    if (state.attempts === 1){
      mark('yellow');
      setFeedback("Not yet. Try again.", "warn");
      showInfo("Hint", explainText(q), q);
      return;
    }

    mark('red');
    setFeedback(`Not quite. The answer is ${q.answer}.`, "bad");

    lockInputs();
    checkBtn.disabled = true;

    showInfo("Explanation", explainText(q), q);

    nextBtn.style.display = 'inline-block';
    nextBtn.textContent = (state.qIndex === Q_COUNT-1) ? "Finish" : "Next";
  }

  const state = {
    questions: [],
    qIndex: 0,
    attempts: 0,
    current: null,
    lights: Array(Q_COUNT).fill('blank'),
    finished: false,
    timerId: null,
    t0: 0,
    elapsedMs: 0,
    running: false
  };

  bestOut.textContent = bestLine(loadBest());
  refreshLights();

  checkBtn.addEventListener('click', () => onCheck());
  nextBtn.addEventListener('click', () => nextQ());
  againBtn.addEventListener('click', () => startSet());

  rNumIn.addEventListener('keydown', (e) => { if (e.key === 'Enter') onCheck(); });
  rDenIn.addEventListener('keydown', (e) => { if (e.key === 'Enter') onCheck(); });

  startSet();
})();
</script>

</body>
</html>
